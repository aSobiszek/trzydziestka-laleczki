<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="theme-color" content="#ff6b6b">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ðŸŒº</text></svg>">
    <title>Madeirskie Bingo</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@400;600;700;800&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        html {
            overflow-x: hidden;
        }

        body {
            overflow-x: hidden;
            overflow-y: auto;
        }

        body {
            font-family: 'Quicksand', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            min-height: 100vh;
            background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 50%, #fdfcfb 100%);
            padding: 30px 12px 120px;
            position: relative;
            -webkit-tap-highlight-color: transparent;
        }

        /* ===== PHOTO WALL ===== */
        .photo-wall {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: 0;
            pointer-events: none;
        }

        .bg-photo {
            position: absolute;
            width: 130px;
            background: white;
            padding: 5px 5px 20px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.12);
            opacity: 0.65;
            animation: photo-float 8s ease-in-out infinite;
        }

        .bg-photo img {
            width: 100%;
            aspect-ratio: 1;
            object-fit: cover;
            display: block;
        }

        @keyframes photo-float {
            0%, 100% { transform: translateY(0) rotate(var(--rot)); }
            50% { transform: translateY(-10px) rotate(var(--rot)); }
        }

        @media (min-width: 500px) {
            .bg-photo { width: 180px; padding: 7px 7px 28px; }
        }

        /* ===== CONTAINER ===== */
        .container {
            position: relative;
            z-index: 1;
            max-width: 75%;
            margin: 0 auto;
        }

        @media (max-width: 600px) {
            .container { max-width: 92%; }
        }

        @media (min-width: 1024px) {
            .container { max-width: 560px; }
        }

        /* ===== HEADER ===== */
        header {
            text-align: center;
            padding: 12px 0 8px;
            color: #333;
        }

        .title {
            font-size: 1.8rem;
            font-weight: 800;
            color: #d63384;
            text-shadow: 0 2px 8px rgba(214,51,132,0.15);
            line-height: 1.3;
        }

        .title del {
            color: #999;
            text-decoration-color: #d63384;
            text-decoration-thickness: 3px;
            font-weight: 600;
        }

        .subtitle {
            font-size: 1rem;
            color: #666;
            margin-top: 6px;
            font-weight: 600;
        }

        .progress-wrap {
            margin-top: 14px;
        }

        .progress-bar {
            background: rgba(0,0,0,0.08);
            border-radius: 20px;
            height: 10px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #f093fb, #f5576c);
            border-radius: 20px;
            transition: width 0.6s cubic-bezier(0.25, 1, 0.5, 1);
            width: 0%;
        }

        .progress-text {
            font-size: 0.8rem;
            color: #999;
            margin-top: 4px;
            font-weight: 600;
        }

        /* ===== BINGO GRID ===== */
        .grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            margin-top: 16px;
        }

        .cell {
            aspect-ratio: 1;
            background: rgba(255,255,255,0.85);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-radius: 16px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 8px 4px;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(0,0,0,0.06);
            transition: transform 0.15s ease, box-shadow 0.15s ease;
            position: relative;
            overflow: hidden;
            border: 2px solid transparent;
        }

        .cell:active {
            transform: scale(0.93);
        }

        .cell .emoji {
            font-size: 2rem;
            line-height: 1;
        }

        .cell .cell-title {
            font-size: 0.6rem;
            font-weight: 700;
            color: #444;
            text-align: center;
            margin-top: 4px;
            line-height: 1.2;
            letter-spacing: -0.01em;
        }

        .cell.done {
            background: linear-gradient(135deg, #fff9e6, #fff3cc);
            border-color: #ffc107;
            box-shadow: 0 0 20px rgba(255,193,7,0.2);
        }

        .cell.done::after {
            content: '\2713';
            position: absolute;
            top: 3px;
            right: 5px;
            font-size: 0.85rem;
            color: #4caf50;
            font-weight: 800;
        }

        .cell.done .cell-photo-bg {
            position: absolute;
            inset: 0;
            background-size: cover;
            background-position: center;
            opacity: 0.15;
            border-radius: 14px;
        }

        .cell.bingo-line {
            animation: glow-pulse 0.5s ease 4;
        }

        @keyframes glow-pulse {
            50% { box-shadow: 0 0 25px rgba(255,193,7,0.7); transform: scale(1.08); }
        }

        /* ===== MODAL ===== */
        .modal-overlay {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.5);
            backdrop-filter: blur(6px);
            -webkit-backdrop-filter: blur(6px);
            z-index: 100;
            align-items: center;
            justify-content: center;
            padding: 24px;
        }

        .modal-overlay.open { display: flex; }

        .modal {
            background: white;
            border-radius: 24px;
            padding: 28px 22px 22px;
            max-width: 340px;
            width: 100%;
            text-align: center;
            animation: modal-pop 0.25s cubic-bezier(0.34, 1.56, 0.64, 1);
            max-height: 90vh;
            overflow-y: auto;
        }

        @keyframes modal-pop {
            from { transform: scale(0.85); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }

        .modal-emoji { font-size: 3.5rem; }
        .modal-title {
            font-size: 1.4rem;
            font-weight: 800;
            color: #333;
            margin: 10px 0 6px;
        }
        .modal-desc {
            font-size: 0.92rem;
            color: #666;
            line-height: 1.5;
            margin-bottom: 18px;
            font-weight: 500;
        }

        .modal-photo {
            width: 100%;
            max-height: 200px;
            object-fit: cover;
            border-radius: 14px;
            margin-bottom: 14px;
            display: none;
        }

        .btn {
            display: inline-block;
            padding: 12px 22px;
            border-radius: 50px;
            border: none;
            font-family: 'Quicksand', sans-serif;
            font-size: 0.9rem;
            font-weight: 700;
            cursor: pointer;
            margin: 4px;
            transition: transform 0.15s ease;
            letter-spacing: 0.02em;
        }

        .btn:active { transform: scale(0.94); }

        .btn-mark {
            background: linear-gradient(135deg, #4caf50, #66bb6a);
            color: white;
        }

        .btn-unmark {
            background: linear-gradient(135deg, #ef5350, #e57373);
            color: white;
        }

        .btn-camera {
            background: linear-gradient(135deg, #42a5f5, #64b5f6);
            color: white;
        }

        .btn-close {
            background: #f0f0f0;
            color: #888;
        }

        /* ===== CELEBRATION ===== */
        .celebration {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.85);
            z-index: 200;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            color: white;
            text-align: center;
            padding: 24px;
        }

        .celebration.open { display: flex; }

        .celebration h2 {
            font-size: 2.8rem;
            font-weight: 800;
            animation: celebrate-bounce 0.6s ease infinite alternate;
        }

        @keyframes celebrate-bounce {
            from { transform: scale(1) rotate(-2deg); }
            to { transform: scale(1.08) rotate(2deg); }
        }

        .celebration p {
            font-size: 1.1rem;
            margin-top: 10px;
            opacity: 0.8;
            font-weight: 600;
        }

        .celebration .btn { margin-top: 24px; }

        /* ===== CONFETTI ===== */
        .confetti-piece {
            position: fixed;
            top: -20px;
            z-index: 250;
            pointer-events: none;
            animation: confetti-fall linear forwards;
        }

        @keyframes confetti-fall {
            to { transform: translateY(110vh) rotate(1080deg); opacity: 0; }
        }

        /* ===== INTRO SPLASH ===== */
        .splash {
            position: fixed;
            inset: 0;
            z-index: 500;
            background: linear-gradient(135deg, #ff9a9e 0%, #fecfef 50%, #f6d365 100%);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            transition: opacity 0.8s ease, transform 0.8s ease;
            padding: 24px;
        }

        .splash.fade-out {
            opacity: 0;
            transform: scale(1.1);
            pointer-events: none;
        }

        .splash-emoji {
            font-size: 5rem;
            animation: splash-bounce 0.6s ease infinite alternate;
        }

        .splash-text {
            font-family: 'Quicksand', sans-serif;
            font-size: 2rem;
            font-weight: 800;
            color: #d63384;
            margin-top: 16px;
            text-shadow: 0 2px 10px rgba(214,51,132,0.2);
        }

        .splash-sub {
            font-family: 'Quicksand', sans-serif;
            font-size: 1.1rem;
            font-weight: 600;
            color: #666;
            margin-top: 8px;
        }

        @keyframes splash-bounce {
            from { transform: scale(1) rotate(-5deg); }
            to { transform: scale(1.15) rotate(5deg); }
        }

        .splash-confetti {
            position: fixed;
            top: -20px;
            z-index: 501;
            pointer-events: none;
            animation: confetti-fall linear forwards;
        }

        /* ===== FOOTER ===== */
        .footer {
            text-align: center;
            margin-top: 24px;
            padding: 8px;
        }

        .footer .reset-link {
            font-size: 0.7rem;
            color: #ccc;
            text-decoration: none;
            cursor: pointer;
        }

        .footer .reset-link:hover { color: #999; }
    </style>
</head>
<body>

    <!-- Intro Splash -->
    <div class="splash" id="splash">
        <div class="splash-emoji">ðŸŽ‚</div>
        <div class="splash-text">Wszystkiego najlepszego!</div>
        <div class="splash-sub">Twoja niespodzianka czeka...</div>
    </div>

    <!-- Background Photo Wall -->
    <div class="photo-wall" id="photoWall"></div>

    <!-- Main Content -->
    <div class="container">
        <header>
            <div class="title">Madeirskie <del>ÅšmigÅ‚o</del> Bingo!</div>
            <div class="subtitle">Wszystkiego najlepszego! ðŸŽ‚ Odkrywaj wyspÄ™!</div>
            <div class="progress-wrap">
                <div class="progress-bar"><div class="progress-fill" id="progressFill"></div></div>
                <div class="progress-text" id="progressText">0 / 16</div>
            </div>
        </header>

        <div class="grid" id="grid"></div>

        <div class="footer">
            <a class="reset-link" id="resetBtn">reset</a>
        </div>
    </div>

    <!-- Detail Modal -->
    <div class="modal-overlay" id="modalOverlay">
        <div class="modal">
            <div class="modal-emoji" id="mEmoji"></div>
            <div class="modal-title" id="mTitle"></div>
            <div class="modal-desc" id="mDesc"></div>
            <img class="modal-photo" id="mPhoto" alt="">
            <div id="mButtons"></div>
        </div>
    </div>

    <!-- Celebration Overlay -->
    <div class="celebration" id="celebration">
        <h2>BINGO! ðŸŽ‰</h2>
        <p id="celebText">Linia ukonczona!</p>
        <button class="btn btn-close" onclick="closeCelebration()">Super! ðŸ¥³</button>
    </div>

    <!-- Hidden file input for photos -->
    <input type="file" id="fileInput" accept="image/*" style="display:none">

    <script>
    // ===== BACKGROUND PHOTOS CONFIG =====
    // Put her photos in img/ folder, then list filenames here:
    const BG_PHOTOS = [
        'img/IMG_0121.jpg',
        'img/IMG_0154.jpg',
        'img/IMG_0428.jpg',
        'img/IMG_0502.jpg',
        'img/IMG_0956.jpg',
        'img/IMG_1189.jpg',
        'img/IMG_2748.jpg',
        'img/IMG_3156.jpg',
        'img/IMG_7636.jpg',
        'img/IMG_8507.jpg',
        'img/IMG_8533.jpg',
        'img/IMG_8671.jpg',
        'img/IMG_8692.jpg',
        'img/IMG_9023.jpg',
        'img/IMG_9150.jpg',
        'img/IMG_9338.jpg',
        'img/IMG_9515.jpg',
        'img/IMG_9942.jpg',
        'img/49f1b61dd2d43c3f09043a076d021beb.JPEG',
        'img/fb4c91fac4e3f10569c2cb47f53d01ff.JPEG',
    ];

    // Place photos around edges: left, right columns + top/bottom rows
    // Photos use px positions calculated from actual page dimensions
    function placePhotos(wall, photos) {
        const pageW = document.body.scrollWidth;
        const pageH = document.body.scrollHeight;
        const photoSize = Math.max(120, Math.min(160, pageW * 0.1));
        // Content zone (where NOT to place photo centers): ~12.5% to ~87.5% horizontally
        const contentLeft = pageW * 0.12;
        const contentRight = pageW * 0.88;

        // Shuffle
        const shuffled = [...photos].sort(() => Math.random() - 0.5);

        // Distribute: 7 left, 7 right, 3 top, 3 bottom
        const leftCount = 7;
        const rightCount = 7;
        const topCount = 3;
        const bottomCount = Math.max(0, shuffled.length - leftCount - rightCount - topCount);
        let idx = 0;

        // LEFT column: spread from top to bottom
        for (let i = 0; i < leftCount && idx < shuffled.length; i++, idx++) {
            const ySpacing = (pageH - photoSize) / leftCount;
            const y = i * ySpacing + Math.random() * ySpacing * 0.4;
            const x = Math.random() * (contentLeft - photoSize * 0.3);
            addPhoto(wall, shuffled[idx], x, y, photoSize);
        }
        // RIGHT column
        for (let i = 0; i < rightCount && idx < shuffled.length; i++, idx++) {
            const ySpacing = (pageH - photoSize) / rightCount;
            const y = i * ySpacing + Math.random() * ySpacing * 0.4;
            const x = contentRight + Math.random() * (pageW - contentRight - photoSize * 0.7);
            addPhoto(wall, shuffled[idx], x, y, photoSize);
        }
        // TOP row: spread across content zone
        for (let i = 0; i < topCount && idx < shuffled.length; i++, idx++) {
            const xSpacing = (contentRight - contentLeft) / topCount;
            const x = contentLeft + i * xSpacing + Math.random() * xSpacing * 0.5;
            const y = Math.random() * 10;
            addPhoto(wall, shuffled[idx], x, y, photoSize);
        }
        // BOTTOM row: below content
        for (let i = 0; i < bottomCount && idx < shuffled.length; i++, idx++) {
            const xSpacing = (contentRight - contentLeft) / Math.max(bottomCount, 1);
            const x = contentLeft + i * xSpacing + Math.random() * xSpacing * 0.5;
            const y = pageH - photoSize - 30 - Math.random() * 40;
            addPhoto(wall, shuffled[idx], x, y, photoSize);
        }
    }

    function addPhoto(wall, src, x, y, size) {
        const s = size + Math.random() * 30 - 15;
        const rot = (Math.random() * 24 - 12).toFixed(1);
        const div = document.createElement('div');
        div.className = 'bg-photo';
        div.style.cssText = 'left:' + x.toFixed(0) + 'px;top:' + y.toFixed(0) + 'px;width:' + s.toFixed(0) + 'px;transform:rotate(' + rot + 'deg);--rot:' + rot + 'deg;animation-delay:' + (Math.random()*6).toFixed(1) + 's;animation-duration:' + (6+Math.random()*5).toFixed(1) + 's';
        div.innerHTML = '<img src="' + src + '" alt="">';
        wall.appendChild(div);
    }

    // ===== BINGO ITEMS (16) =====
    const ITEMS = [
        { emoji: 'ðŸ¹', title: 'Poncha',          desc: 'Wypij lokalny koktajl z rumu trzcinowego, miodu i cytryny. NajsÅ‚ynniejszy drink Madery!' },
        { emoji: 'ðŸš¡', title: 'TelefÃ©rico',       desc: 'WjedÅº kolejkÄ… linowÄ… z Funchal na wzgÃ³rze Monte. 15 minut z widokiem na caÅ‚e miasto i ocean!' },
        { emoji: 'ðŸŸ', title: 'Espada & Banana',  desc: 'Czarna ryba szpadowa podawana z bananem. Brzmi dziwnie? Smakuje genialnie. Tylko na Maderze!' },
        { emoji: 'ðŸ¥¾', title: 'Levada Walk',      desc: 'Spacer wzdÅ‚uÅ¼ lewad, staroÅ¼ytnych kanaÅ‚Ã³w irygacyjnych, przez magiczny laurowy las.' },
        { emoji: 'ðŸ˜±', title: 'Cabo GirÃ£o',       desc: 'Szklany taras nad jednym z najwyÅ¼szych klifÃ³w w Europie (580m). SpÃ³jrz w dÃ³Å‚... jeÅ›li siÄ™ odwaÅ¼ysz!' },
        { emoji: 'ðŸž', title: 'Bolo do Caco',     desc: 'CiepÅ‚y chlebek ze sÅ‚odkich ziemniakÃ³w z masÅ‚em czosnkowym. Znajdziesz go wszÄ™dzie!' },
        { emoji: 'ðŸŠ', title: 'Porto Moniz',      desc: 'KÄ…piel w naturalnych basenach z wulkanicznej lawy, wypeÅ‚nionych oceanem Atlantyckim.' },
        { emoji: 'ðŸ·', title: 'Vinho Madeira',    desc: 'Degustacja sÅ‚ynnego wina Madery. Jedno z najstarszych win Å›wiata, wzmacniane ciepÅ‚em.' },
        { emoji: 'ðŸ›·', title: 'Toboggan',         desc: 'Zjazd wiklinowymi saniami po ulicach Monte! Popychany przez dwÃ³ch panÃ³w w biaÅ‚ych strojach i sÅ‚omianych kapeluszach.' },
        { emoji: 'ðŸš', title: 'Lapas',            desc: 'Grillowane Å›limaki morskie z masÅ‚em, czosnkiem i cytrynÄ…. Klasyczna przystawka z nadmorskich knajp.' },
        { emoji: 'ðŸŒ…', title: 'Pico do Arieiro',  desc: 'WschÃ³d sÅ‚oÅ„ca ponad chmurami na 1818m n.p.m. Jeden z najpiÄ™kniejszych widokÃ³w w Europie.' },
        { emoji: 'ðŸ¨', title: 'Nikita',           desc: 'Lody waniliowe zblendowane z piwem i ananasem. Szalone? Tak. Pyszne? Bardzo.' },
        { emoji: 'ðŸª', title: 'Mercado Funchal',  desc: 'OdwiedÅº Mercado dos Lavradores. Kolorowy targ z kwiatami, owocami tropikalnymi i rybami.' },
        { emoji: 'ðŸ¥©', title: 'Espetada',         desc: 'SÅ‚ynny szaszÅ‚yk z woÅ‚owiny, grillowany na gaÅ‚Ä™zi wawrzynu i podawany wiszÄ…co nad stoÅ‚em!' },
        { emoji: 'ðŸº', title: 'Coral Beer',       desc: 'Wypij lokalne piwo Coral. Lekkie, orzeÅºwiajÄ…ce i wszÄ™dzie na wyspie.' },
        { emoji: 'ðŸŽ', title: 'TÃ¼rÃ¶l Madeira',    desc: '??? Niespodzianka! Dowiesz siÄ™ na miejscu ðŸ˜' },
    ];

    const STORAGE_KEY = 'madeira-bingo-v2';
    let state = loadState();
    let activeIdx = null;

    // ===== STATE MANAGEMENT =====
    function loadState() {
        try {
            const s = localStorage.getItem(STORAGE_KEY);
            if (s) return JSON.parse(s);
        } catch(e) {}
        return { done: [], photos: {}, celebrated: [] };
    }

    function saveState() {
        try { localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); } catch(e) {}
    }

    // ===== RENDER =====
    function render() {
        const grid = document.getElementById('grid');
        grid.innerHTML = '';

        ITEMS.forEach((item, i) => {
            const cell = document.createElement('div');
            const isDone = state.done.includes(i);
            cell.className = 'cell' + (isDone ? ' done' : '');

            // Trip photo background (from camera during trip)
            if (state.photos[i]) {
                const bg = document.createElement('div');
                bg.className = 'cell-photo-bg';
                bg.style.backgroundImage = 'url(' + state.photos[i] + ')';
                cell.appendChild(bg);
            }

            const emoji = document.createElement('div');
            emoji.className = 'emoji';
            emoji.textContent = item.emoji;
            cell.appendChild(emoji);

            const title = document.createElement('div');
            title.className = 'cell-title';
            title.textContent = item.title;
            cell.appendChild(title);

            cell.onclick = () => openModal(i);
            grid.appendChild(cell);
        });

        updateProgress();
    }

    function updateProgress() {
        const n = state.done.length;
        document.getElementById('progressFill').style.width = (n / 16 * 100) + '%';
        document.getElementById('progressText').textContent = n + ' / 16';
    }

    // ===== MODAL =====
    function openModal(i) {
        activeIdx = i;
        const item = ITEMS[i];
        const isDone = state.done.includes(i);

        document.getElementById('mEmoji').textContent = item.emoji;
        document.getElementById('mTitle').textContent = item.title;
        document.getElementById('mDesc').textContent = item.desc;

        const photo = document.getElementById('mPhoto');
        if (state.photos[i]) {
            photo.src = state.photos[i];
            photo.style.display = 'block';
        } else {
            photo.style.display = 'none';
        }

        let html = '';
        if (isDone) {
            html += '<button class="btn btn-unmark" onclick="toggleDone(' + i + ')">Cofnij â†©</button> ';
            html += '<button class="btn btn-camera" onclick="openCamera()">ðŸ“¸</button>';
        } else {
            html += '<button class="btn btn-mark" onclick="toggleDone(' + i + ')">Zaliczone! âœ“</button>';
        }
        html += '<br><button class="btn btn-close" onclick="closeModal()" style="margin-top:8px">Zamknij</button>';
        document.getElementById('mButtons').innerHTML = html;

        document.getElementById('modalOverlay').classList.add('open');
    }

    function closeModal() {
        document.getElementById('modalOverlay').classList.remove('open');
        activeIdx = null;
    }

    function toggleDone(i) {
        const idx = state.done.indexOf(i);
        if (idx >= 0) {
            state.done.splice(idx, 1);
            delete state.photos[i];
        } else {
            state.done.push(i);
        }
        saveState();
        render();
        openModal(i);
        checkBingo();
    }

    // Close modal on backdrop click
    document.getElementById('modalOverlay').addEventListener('click', function(e) {
        if (e.target === this) closeModal();
    });

    // ===== CAMERA / PHOTO =====
    function openCamera() {
        document.getElementById('fileInput').click();
    }

    document.getElementById('fileInput').addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (!file || activeIdx === null) return;

        const reader = new FileReader();
        reader.onload = function(ev) {
            const img = new Image();
            img.onload = function() {
                const canvas = document.createElement('canvas');
                const size = 400;
                canvas.width = size;
                canvas.height = size;
                const ctx = canvas.getContext('2d');
                const min = Math.min(img.width, img.height);
                const sx = (img.width - min) / 2;
                const sy = (img.height - min) / 2;
                ctx.drawImage(img, sx, sy, min, min, 0, 0, size, size);
                state.photos[activeIdx] = canvas.toDataURL('image/jpeg', 0.7);
                saveState();
                render();
                if (activeIdx !== null) openModal(activeIdx);
            };
            img.src = ev.target.result;
        };
        reader.readAsDataURL(file);
        this.value = '';
    });

    // ===== BINGO DETECTION =====
    const WIN_LINES = [
        [0,1,2,3], [4,5,6,7], [8,9,10,11], [12,13,14,15],   // rows
        [0,4,8,12], [1,5,9,13], [2,6,10,14], [3,7,11,15],     // cols
        [0,5,10,15], [3,6,9,12]                                 // diagonals
    ];

    function checkBingo() {
        for (const line of WIN_LINES) {
            const key = line.join(',');
            if (state.celebrated.includes(key)) continue;
            if (line.every(i => state.done.includes(i))) {
                state.celebrated.push(key);
                saveState();
                setTimeout(() => {
                    closeModal();
                    showCelebration(line);
                }, 300);
                return;
            }
        }
    }

    function showCelebration(line) {
        // Highlight the winning line
        const cells = document.querySelectorAll('.cell');
        line.forEach(i => cells[i].classList.add('bingo-line'));

        document.getElementById('celebration').classList.add('open');
        spawnConfetti();
    }

    function closeCelebration() {
        document.getElementById('celebration').classList.remove('open');
        document.querySelectorAll('.confetti-piece').forEach(c => c.remove());
        document.querySelectorAll('.bingo-line').forEach(c => c.classList.remove('bingo-line'));
    }

    function spawnConfetti() {
        const colors = ['#f44336','#e91e63','#9c27b0','#2196f3','#4caf50','#ffeb3b','#ff9800','#f06292','#ba68c8'];
        for (let i = 0; i < 80; i++) {
            const el = document.createElement('div');
            el.className = 'confetti-piece';
            el.style.left = Math.random() * 100 + 'vw';
            el.style.background = colors[Math.floor(Math.random() * colors.length)];
            el.style.animationDuration = (2 + Math.random() * 3) + 's';
            el.style.animationDelay = Math.random() * 1.5 + 's';
            el.style.width = (6 + Math.random() * 10) + 'px';
            el.style.height = (6 + Math.random() * 10) + 'px';
            el.style.borderRadius = Math.random() > 0.5 ? '50%' : '2px';
            document.body.appendChild(el);
        }
        setTimeout(() => {
            document.querySelectorAll('.confetti-piece').forEach(c => c.remove());
        }, 7000);
    }

    // ===== RESET =====
    document.getElementById('resetBtn').addEventListener('click', function(e) {
        e.preventDefault();
        if (confirm('Na pewno zresetowaÄ‡? Stracisz wszystkie zaznaczenia i zdjÄ™cia!')) {
            localStorage.removeItem(STORAGE_KEY);
            state = { done: [], photos: {}, celebrated: [] };
            render();
        }
    });

    // ===== BACKGROUND PHOTO WALL =====
    function renderPhotoWall() {
        if (BG_PHOTOS.length === 0) return;
        const wall = document.getElementById('photoWall');
        // Wait for layout to settle, then place photos based on actual dimensions
        requestAnimationFrame(() => {
            placePhotos(wall, BG_PHOTOS);
        });
    }

    // ===== FANFARE (Web Audio API) =====
    function playFanfare() {
        try {
            const ctx = new (window.AudioContext || window.webkitAudioContext)();
            const notes = [
                { freq: 523, start: 0,    dur: 0.15 },  // C5
                { freq: 659, start: 0.15, dur: 0.15 },  // E5
                { freq: 784, start: 0.3,  dur: 0.15 },  // G5
                { freq: 1047, start: 0.45, dur: 0.4 },  // C6 (hold)
                { freq: 784, start: 0.9,  dur: 0.12 },  // G5
                { freq: 1047, start: 1.05, dur: 0.5 },  // C6 (final hold)
            ];
            notes.forEach(n => {
                const osc = ctx.createOscillator();
                const gain = ctx.createGain();
                osc.type = 'triangle';
                osc.frequency.value = n.freq;
                gain.gain.setValueAtTime(0, ctx.currentTime + n.start);
                gain.gain.linearRampToValueAtTime(0.12, ctx.currentTime + n.start + 0.03);
                gain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + n.start + n.dur);
                osc.connect(gain);
                gain.connect(ctx.destination);
                osc.start(ctx.currentTime + n.start);
                osc.stop(ctx.currentTime + n.start + n.dur + 0.05);
            });
        } catch(e) {}
    }

    // ===== INTRO SPLASH =====
    function introConfetti() {
        const colors = ['#f44336','#e91e63','#9c27b0','#2196f3','#4caf50','#ffeb3b','#ff9800','#f06292','#ba68c8','#ff6f00','#00e676'];
        for (let i = 0; i < 100; i++) {
            const el = document.createElement('div');
            el.className = 'splash-confetti';
            el.style.left = Math.random() * 100 + 'vw';
            el.style.background = colors[Math.floor(Math.random() * colors.length)];
            el.style.animationDuration = (2.5 + Math.random() * 3) + 's';
            el.style.animationDelay = Math.random() * 1.2 + 's';
            el.style.width = (8 + Math.random() * 12) + 'px';
            el.style.height = (8 + Math.random() * 12) + 'px';
            el.style.borderRadius = Math.random() > 0.5 ? '50%' : '2px';
            document.body.appendChild(el);
        }
    }

    function startIntro() {
        introConfetti();
        // Play fanfare on first user tap (autoplay policy) or immediately
        playFanfare();
        document.addEventListener('touchstart', function once() {
            playFanfare();
            document.removeEventListener('touchstart', once);
        }, { once: true });

        setTimeout(() => {
            const splash = document.getElementById('splash');
            splash.classList.add('fade-out');
            setTimeout(() => {
                splash.style.display = 'none';
                document.querySelectorAll('.splash-confetti').forEach(c => c.remove());
            }, 800);
        }, 3500);
    }

    // ===== INIT =====
    render();
    renderPhotoWall();
    startIntro();
    </script>
</body>
</html>
